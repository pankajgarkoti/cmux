#!/usr/bin/env bash
#═══════════════════════════════════════════════════════════════════════════════
# projects - Manage the CMUX project registry
#
# Usage:
#   projects add <path> [--name NAME] [--description DESC]
#   projects remove <id>
#   projects list
#   projects info <id>
#   projects activate <id>
#   projects deactivate <id>
#═══════════════════════════════════════════════════════════════════════════════

set -euo pipefail

CMUX_HOME="${CMUX_HOME:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"
REGISTRY="${CMUX_HOME}/.cmux/projects.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

#───────────────────────────────────────────────────────────────────────────────
# Helpers
#───────────────────────────────────────────────────────────────────────────────

die() { echo -e "${RED}error:${NC} $1" >&2; exit 1; }
info() { echo -e "${CYAN}▶${NC} $1"; }
ok() { echo -e "${GREEN}✓${NC} $1"; }
warn() { echo -e "${YELLOW}!${NC} $1"; }

ensure_registry() {
    if [[ ! -f "$REGISTRY" ]]; then
        mkdir -p "$(dirname "$REGISTRY")"
        echo '{"projects":[]}' > "$REGISTRY"
    fi
}

project_exists() {
    local id="$1"
    jq -e --arg id "$id" '.projects[] | select(.id == $id)' "$REGISTRY" > /dev/null 2>&1
}

detect_git_remote() {
    local dir="$1"
    git -C "$dir" remote get-url origin 2>/dev/null || echo ""
}

detect_language() {
    local dir="$1"
    if [[ -f "$dir/pyproject.toml" ]] || [[ -f "$dir/setup.py" ]]; then
        echo "python"
    elif [[ -f "$dir/package.json" ]]; then
        echo "javascript"
    elif [[ -f "$dir/Cargo.toml" ]]; then
        echo "rust"
    elif [[ -f "$dir/go.mod" ]]; then
        echo "go"
    elif [[ -f "$dir/pom.xml" ]] || [[ -f "$dir/build.gradle" ]]; then
        echo "java"
    elif [[ -f "$dir/Gemfile" ]]; then
        echo "ruby"
    else
        echo "unknown"
    fi
}

#───────────────────────────────────────────────────────────────────────────────
# Commands
#───────────────────────────────────────────────────────────────────────────────

cmd_add() {
    local path=""
    local name=""
    local description=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --name)
                [[ -z "${2:-}" ]] && die "--name requires a value"
                name="$2"
                shift 2
                ;;
            --description|--desc)
                [[ -z "${2:-}" ]] && die "--description requires a value"
                description="$2"
                shift 2
                ;;
            *)
                if [[ -z "$path" ]]; then
                    path="$1"
                else
                    die "unexpected argument: $1"
                fi
                shift
                ;;
        esac
    done

    [[ -z "$path" ]] && die "usage: projects add <path> [--name NAME] [--description DESC]"

    # Resolve to absolute path
    [[ -d "$path" ]] || die "directory does not exist: $path"
    path="$(cd "$path" && pwd)"

    # Derive ID from directory basename
    local id
    id="$(basename "$path" | tr '[:upper:]' '[:lower:]' | tr ' .' '-' | tr -cd 'a-z0-9-')"
    [[ -z "$id" ]] && die "could not derive project ID from path"

    ensure_registry

    if project_exists "$id"; then
        die "project '$id' already registered (use 'projects remove $id' first)"
    fi

    # Auto-detect
    local git_remote
    git_remote=$(detect_git_remote "$path")
    local language
    language=$(detect_language "$path")

    # Defaults
    [[ -z "$name" ]] && name="$(basename "$path")"
    [[ -z "$description" ]] && description=""

    local now
    now="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

    info "Registering project: $id"

    # Add to registry
    local tmp
    tmp=$(mktemp)
    jq --arg id "$id" \
       --arg name "$name" \
       --arg path "$path" \
       --arg desc "$description" \
       --arg remote "$git_remote" \
       --arg lang "$language" \
       --arg now "$now" \
       '.projects += [{
           id: $id,
           name: $name,
           path: $path,
           is_self: false,
           active: false,
           supervisor_agent_id: null,
           hooks_installed: false,
           added_at: $now,
           git_remote: $remote,
           language: $lang,
           description: $desc
       }]' "$REGISTRY" > "$tmp" && mv "$tmp" "$REGISTRY"

    ok "Project '$id' registered"
    echo ""
    echo "  Path:     $path"
    echo "  Language: $language"
    [[ -n "$git_remote" ]] && echo "  Remote:   $git_remote"
    [[ -n "$description" ]] && echo "  Desc:     $description"
    echo ""
    echo "Run 'projects activate $id' to start a project supervisor."
}

cmd_remove() {
    local id="${1:-}"
    [[ -z "$id" ]] && die "usage: projects remove <id>"

    ensure_registry

    if ! project_exists "$id"; then
        die "project '$id' not found"
    fi

    # Prevent removing self-project
    local is_self
    is_self=$(jq -r --arg id "$id" '.projects[] | select(.id == $id) | .is_self' "$REGISTRY")
    if [[ "$is_self" == "true" ]]; then
        die "cannot remove CMUX self-project"
    fi

    info "Removing project: $id"

    local tmp
    tmp=$(mktemp)
    jq --arg id "$id" '.projects |= map(select(.id != $id))' "$REGISTRY" > "$tmp" && mv "$tmp" "$REGISTRY"

    ok "Project '$id' removed"
}

cmd_list() {
    ensure_registry

    local count
    count=$(jq '.projects | length' "$REGISTRY")

    if [[ "$count" -eq 0 ]]; then
        echo -e "${DIM}No projects registered${NC}"
        return
    fi

    printf "${BOLD}%-16s %-20s %-8s %-10s %s${NC}\n" "ID" "NAME" "ACTIVE" "LANGUAGE" "PATH"
    printf "%-16s %-20s %-8s %-10s %s\n" "────────────────" "────────────────────" "────────" "──────────" "────────────────────"

    jq -r '.projects[] | [.id, .name, (if .active then "yes" else "no" end), .language, .path] | @tsv' "$REGISTRY" | \
    while IFS=$'\t' read -r id name active lang path; do
        local color="$NC"
        if [[ "$active" == "yes" ]]; then
            color="$GREEN"
        fi
        printf "${color}%-16s %-20s %-8s %-10s %s${NC}\n" "$id" "$name" "$active" "$lang" "$path"
    done

    echo ""
    echo "Total: $count project(s)"
}

cmd_info() {
    local id="${1:-}"
    [[ -z "$id" ]] && die "usage: projects info <id>"

    ensure_registry

    if ! project_exists "$id"; then
        die "project '$id' not found"
    fi

    local data
    data=$(jq --arg id "$id" '.projects[] | select(.id == $id)' "$REGISTRY")

    echo -e "${BOLD}Project: $(echo "$data" | jq -r '.name')${NC}"
    echo ""
    echo "  ID:          $(echo "$data" | jq -r '.id')"
    echo "  Path:        $(echo "$data" | jq -r '.path')"
    echo "  Active:      $(echo "$data" | jq -r 'if .active then "yes" else "no" end')"
    echo "  Language:    $(echo "$data" | jq -r '.language // "unknown"')"
    echo "  Self:        $(echo "$data" | jq -r 'if .is_self then "yes" else "no" end')"
    echo "  Supervisor:  $(echo "$data" | jq -r '.supervisor_agent_id // "none"')"
    echo "  Hooks:       $(echo "$data" | jq -r 'if .hooks_installed then "installed" else "not installed" end')"
    echo "  Remote:      $(echo "$data" | jq -r '.git_remote // "none"')"
    echo "  Description: $(echo "$data" | jq -r '.description // "none"')"
    echo "  Added:       $(echo "$data" | jq -r '.added_at')"
}

cmd_activate() {
    local id="${1:-}"
    [[ -z "$id" ]] && die "usage: projects activate <id>"

    ensure_registry

    if ! project_exists "$id"; then
        die "project '$id' not found"
    fi

    local already_active
    already_active=$(jq -r --arg id "$id" '.projects[] | select(.id == $id) | .active' "$REGISTRY")
    if [[ "$already_active" == "true" ]]; then
        warn "project '$id' is already active"
        return 0
    fi

    info "Activating project: $id"

    local tmp
    tmp=$(mktemp)
    jq --arg id "$id" '(.projects[] | select(.id == $id)).active = true' "$REGISTRY" > "$tmp" && mv "$tmp" "$REGISTRY"

    ok "Project '$id' activated"
}

cmd_deactivate() {
    local id="${1:-}"
    [[ -z "$id" ]] && die "usage: projects deactivate <id>"

    ensure_registry

    if ! project_exists "$id"; then
        die "project '$id' not found"
    fi

    # Prevent deactivating self-project
    local is_self
    is_self=$(jq -r --arg id "$id" '.projects[] | select(.id == $id) | .is_self' "$REGISTRY")
    if [[ "$is_self" == "true" ]]; then
        die "cannot deactivate CMUX self-project"
    fi

    local already_inactive
    already_inactive=$(jq -r --arg id "$id" '.projects[] | select(.id == $id) | .active' "$REGISTRY")
    if [[ "$already_inactive" == "false" ]]; then
        warn "project '$id' is already inactive"
        return 0
    fi

    info "Deactivating project: $id"

    local tmp
    tmp=$(mktemp)
    jq --arg id "$id" '(.projects[] | select(.id == $id)).active = false' "$REGISTRY" > "$tmp" && mv "$tmp" "$REGISTRY"

    ok "Project '$id' deactivated"
}

cmd_help() {
    cat << 'EOF'
projects - Manage the CMUX project registry

USAGE:
    projects <command> [arguments]

COMMANDS:
    add <path> [options]    Register a new project
    remove <id>             Unregister a project
    list                    List all registered projects
    info <id>               Show project details
    activate <id>           Set project as active
    deactivate <id>         Set project as inactive
    help                    Show this help message

ADD OPTIONS:
    --name <name>           Project display name (default: directory basename)
    --description <desc>    Project description

AUTO-DETECTION:
    On add, the tool automatically detects:
    - Git remote (from 'origin')
    - Language (from pyproject.toml, package.json, Cargo.toml, go.mod, etc.)
    - Project ID (from directory basename, lowercased)

EXAMPLES:
    projects add /path/to/my-api --name "My API" --description "REST API service"
    projects list
    projects info my-api
    projects activate my-api
    projects deactivate my-api
    projects remove my-api

ENVIRONMENT:
    CMUX_HOME    CMUX installation root (default: git root or pwd)
EOF
}

#───────────────────────────────────────────────────────────────────────────────
# Main
#───────────────────────────────────────────────────────────────────────────────

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        add)        cmd_add "$@" ;;
        remove)     cmd_remove "$@" ;;
        list)       cmd_list "$@" ;;
        info)       cmd_info "$@" ;;
        activate)   cmd_activate "$@" ;;
        deactivate) cmd_deactivate "$@" ;;
        help|--help|-h) cmd_help ;;
        *)          die "unknown command: $cmd (try 'projects help')" ;;
    esac
}

main "$@"
