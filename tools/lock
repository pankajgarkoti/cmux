#!/usr/bin/env bash
#═══════════════════════════════════════════════════════════════════════════════
# lock - Resource locking for parallel worker coordination
#
# Prevents two workers from editing the same file simultaneously.
# Uses flock(2) under the hood via lib/filelock.sh.
#
# Usage:
#   lock acquire <resource> [timeout]   Acquire lock (blocks until available)
#   lock release <resource>             Release lock
#   lock status [resource]              Show lock status
#   lock run <resource> -- <command>    Run command while holding lock
#   lock help                           Show this help
#
# Workers should acquire locks before editing shared files and release
# after committing. The "run" command is preferred as it auto-releases.
#═══════════════════════════════════════════════════════════════════════════════

set -euo pipefail

CMUX_PROJECT_ROOT="${CMUX_PROJECT_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"

# Source the lock library
source "${CMUX_PROJECT_ROOT}/src/orchestrator/lib/filelock.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

LOCKDIR="/tmp/cmux-resource-locks"

#───────────────────────────────────────────────────────────────────────────────
# Acquire a lock
#───────────────────────────────────────────────────────────────────────────────

cmd_acquire() {
    local resource="${1:-}"
    local timeout="${2:-}"

    if [[ -z "$resource" ]]; then
        echo -e "${RED}error:${NC} usage: lock acquire <resource> [timeout_seconds]"
        exit 1
    fi

    if [[ -n "$timeout" ]]; then
        if resource_trylock "$resource" "$timeout"; then
            echo -e "${GREEN}✓${NC} Acquired lock on ${BOLD}${resource}${NC}"
        else
            echo -e "${RED}✗${NC} Timeout — could not acquire lock on ${BOLD}${resource}${NC} within ${timeout}s"
            exit 1
        fi
    else
        resource_lock "$resource"
        echo -e "${GREEN}✓${NC} Acquired lock on ${BOLD}${resource}${NC}"
    fi
}

#───────────────────────────────────────────────────────────────────────────────
# Release a lock
#───────────────────────────────────────────────────────────────────────────────

cmd_release() {
    local resource="${1:-}"

    if [[ -z "$resource" ]]; then
        echo -e "${RED}error:${NC} usage: lock release <resource>"
        exit 1
    fi

    resource_unlock
    echo -e "${GREEN}✓${NC} Released lock on ${BOLD}${resource}${NC}"
}

#───────────────────────────────────────────────────────────────────────────────
# Run a command while holding a lock (auto-releases)
#───────────────────────────────────────────────────────────────────────────────

cmd_run() {
    local resource="${1:-}"
    shift 2>/dev/null || true

    if [[ -z "$resource" ]]; then
        echo -e "${RED}error:${NC} usage: lock run <resource> -- <command...>"
        exit 1
    fi

    # Skip the -- separator if present
    if [[ "${1:-}" == "--" ]]; then
        shift
    fi

    if [[ $# -eq 0 ]]; then
        echo -e "${RED}error:${NC} no command specified"
        exit 1
    fi

    resource_lock "$resource"
    local exit_code=0
    "$@" || exit_code=$?
    resource_unlock

    return $exit_code
}

#───────────────────────────────────────────────────────────────────────────────
# Show lock status
#───────────────────────────────────────────────────────────────────────────────

cmd_status() {
    local target_resource="${1:-}"

    mkdir -p "$LOCKDIR"
    local lockfiles
    lockfiles=$(ls "$LOCKDIR"/*.lock 2>/dev/null || true)

    if [[ -z "$lockfiles" ]]; then
        echo -e "${DIM}No active locks${NC}"
        return
    fi

    echo -e "${BOLD}Active resource locks:${NC}\n"

    local count=0
    for lockfile in $lockfiles; do
        # Try to read holder info
        local holder_info
        holder_info=$(cat "$lockfile" 2>/dev/null || echo "")

        if [[ -z "$holder_info" ]]; then
            continue
        fi

        local agent timestamp resource
        agent=$(echo "$holder_info" | awk '{print $1}')
        timestamp=$(echo "$holder_info" | awk '{print $2}')
        resource=$(echo "$holder_info" | awk '{$1=""; $2=""; print}' | sed 's/^ *//')

        # Filter if target resource specified
        if [[ -n "$target_resource" ]] && [[ "$resource" != *"$target_resource"* ]]; then
            continue
        fi

        local now age_str=""
        now=$(date +%s)
        if [[ "$timestamp" =~ ^[0-9]+$ ]]; then
            local age=$((now - timestamp))
            if ((age >= 3600)); then
                age_str="${age}s (STALE)"
            elif ((age >= 60)); then
                age_str="$((age / 60))m$((age % 60))s"
            else
                age_str="${age}s"
            fi
        fi

        # Check if lock is actually held (try non-blocking acquire)
        local held=false
        if ! flock -n "$lockfile" true 2>/dev/null; then
            held=true
        fi

        if [[ "$held" == "true" ]]; then
            printf "  ${RED}●${NC} ${BOLD}%-30s${NC} held by %-15s %s\n" "$resource" "$agent" "$age_str"
        else
            printf "  ${DIM}●${NC} ${DIM}%-30s${NC} ${DIM}released (stale lockfile)${NC}\n" "$resource"
        fi
        ((count++))
    done

    if ((count == 0)); then
        echo -e "${DIM}No active locks${NC}"
    fi
}

#───────────────────────────────────────────────────────────────────────────────
# Help
#───────────────────────────────────────────────────────────────────────────────

cmd_help() {
    cat << 'EOF'
lock - Resource locking for parallel worker coordination

USAGE:
    lock acquire <resource> [timeout]   Acquire exclusive lock (blocks)
    lock release <resource>             Release lock
    lock run <resource> -- <command>    Run command while holding lock
    lock status [resource]              Show active locks
    lock help                           Show this help

EXAMPLES:
    lock acquire src/server/routes/agents.py
    # ... edit the file, commit ...
    lock release src/server/routes/agents.py

    lock run src/server/main.py -- git add src/server/main.py

    lock status                         # Show all active locks
    lock status agents.py               # Filter by resource name

NOTES:
    - Workers should lock files before editing and unlock after committing
    - The "run" command is preferred as it auto-releases on completion
    - Locks are per-process; if a worker crashes, locks auto-release
    - Lock files are stored in /tmp/cmux-resource-locks/
EOF
}

#───────────────────────────────────────────────────────────────────────────────
# Main dispatch
#───────────────────────────────────────────────────────────────────────────────

cmd="${1:-help}"
shift 2>/dev/null || true

case "$cmd" in
    acquire)  cmd_acquire "$@" ;;
    release)  cmd_release "$@" ;;
    run)      cmd_run "$@" ;;
    status)   cmd_status "$@" ;;
    help|-h|--help) cmd_help ;;
    *)
        echo -e "${RED}error:${NC} unknown command: $cmd (try 'lock help')"
        exit 1
        ;;
esac
