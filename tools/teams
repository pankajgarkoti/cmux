#!/usr/bin/env bash
#═══════════════════════════════════════════════════════════════════════════════
# teams - Set up, manage, and tear down team structures from templates
#
# Usage:
#   teams setup <TEMPLATE> '<task>' [--name <prefix>] [--project <id>]
#   teams teardown <prefix>         - Kill all workers in a team
#   teams status <prefix>           - Show team members' terminal output
#   teams list                      - List active teams
#   teams templates                 - List available team templates
#═══════════════════════════════════════════════════════════════════════════════

set -euo pipefail

CMUX_HOME="${CMUX_HOME:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"
CMUX_SESSION="${CMUX_SESSION:-cmux}"
TEAMS_FILE="${CMUX_HOME}/.cmux/teams.json"
TEMPLATES_DIR="${CMUX_HOME}/docs/templates/teams"
ROLES_DIR="${CMUX_HOME}/docs/templates/roles"
WORKERS_TOOL="${CMUX_HOME}/tools/workers"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

#───────────────────────────────────────────────────────────────────────────────
# Helpers
#───────────────────────────────────────────────────────────────────────────────

die() { echo -e "${RED}error:${NC} $1" >&2; exit 1; }
info() { echo -e "${CYAN}▶${NC} $1"; }
ok() { echo -e "${GREEN}✓${NC} $1"; }
warn() { echo -e "${YELLOW}!${NC} $1"; }

ensure_teams_file() {
    if [[ ! -f "$TEAMS_FILE" ]]; then
        mkdir -p "$(dirname "$TEAMS_FILE")"
        echo '{"teams":[]}' > "$TEAMS_FILE"
    fi
}

team_exists() {
    local prefix="$1"
    jq -e --arg p "$prefix" '.teams[] | select(.prefix == $p)' "$TEAMS_FILE" > /dev/null 2>&1
}

window_exists() {
    tmux list-windows -t "$CMUX_SESSION" -F '#{window_name}' 2>/dev/null | grep -qx "$1"
}

# Generate a short prefix from a task description
auto_prefix() {
    local task="$1"
    # Take first 2-3 meaningful words, lowercase, join with dash
    echo "$task" | tr '[:upper:]' '[:lower:]' | \
        sed 's/[^a-z0-9 ]//g' | \
        awk '{for(i=1;i<=NF && i<=2;i++) printf "%s-", $i}' | \
        sed 's/-$//' | head -c 20
}

#───────────────────────────────────────────────────────────────────────────────
# Template definitions — which roles to spawn for each template
#───────────────────────────────────────────────────────────────────────────────

# Returns role definitions as lines: <suffix> <role_template_path> <role_label>
get_template_roles() {
    local template="$1"
    case "$template" in
        SOLO_WORKER)
            echo "worker docs/WORKER_ROLE.md Worker"
            ;;
        SQUAD_MODEL)
            echo "squad-lead docs/templates/roles/SQUAD_LEAD.md Squad_Lead"
            echo "backend docs/templates/roles/FEATURE_BACKEND.md Backend"
            echo "frontend docs/templates/roles/FEATURE_FRONTEND.md Frontend"
            echo "tester docs/templates/roles/TESTER.md Tester"
            ;;
        FEATURE_TEAM)
            echo "tech-lead docs/templates/roles/TECH_LEAD.md Tech_Lead"
            echo "backend docs/templates/roles/FEATURE_BACKEND.md Backend"
            echo "frontend docs/templates/roles/FEATURE_FRONTEND.md Frontend"
            ;;
        PLATFORM_TEAM)
            echo "platform-lead docs/templates/roles/PLATFORM_LEAD.md Platform_Lead"
            echo "infra docs/templates/roles/INFRA_WORKER.md Infra"
            echo "devops docs/templates/roles/DEVOPS_WORKER.md DevOps"
            ;;
        TIGER_TEAM)
            echo "tiger-a TIGER_TEAM Tiger_A"
            echo "tiger-b TIGER_TEAM Tiger_B"
            echo "tiger-c TIGER_TEAM Tiger_C"
            ;;
        DEBATE_PAIR)
            echo "defender docs/templates/roles/DEBATE_DEFENDER.md Defender"
            echo "critic docs/templates/roles/DEBATE_CRITIC.md Critic"
            ;;
        *)
            return 1
            ;;
    esac
}

# Returns the lead/coordinator role suffix for a template (empty if flat)
get_lead_suffix() {
    local template="$1"
    case "$template" in
        SQUAD_MODEL)    echo "squad-lead" ;;
        FEATURE_TEAM)   echo "tech-lead" ;;
        PLATFORM_TEAM)  echo "platform-lead" ;;
        *)              echo "" ;;
    esac
}

#───────────────────────────────────────────────────────────────────────────────
# Task construction — build the task string for each worker
#───────────────────────────────────────────────────────────────────────────────

build_worker_task() {
    local template="$1"
    local suffix="$2"
    local role_template="$3"
    local task="$4"
    local prefix="$5"
    local all_members="$6"  # comma-separated list of all member names

    local worker_name="${prefix}-${suffix}"
    local role_label="${suffix//-/ }"

    case "$template" in
        SOLO_WORKER)
            echo "Read ${CMUX_HOME}/docs/WORKER_ROLE.md for your role instructions. Your task: ${task}"
            ;;
        SQUAD_MODEL)
            local lead="${prefix}-squad-lead"
            case "$suffix" in
                squad-lead)
                    echo "Read ${CMUX_HOME}/${role_template} for your role. You lead team '${prefix}'. Team members: ${all_members}. Your task: ${task}"
                    ;;
                *)
                    echo "Read ${CMUX_HOME}/${role_template} for your role. You are on team '${prefix}'. Report to ${lead}. Team members: ${all_members}. Your task (${role_label}): ${task}"
                    ;;
            esac
            ;;
        FEATURE_TEAM)
            local lead="${prefix}-tech-lead"
            case "$suffix" in
                tech-lead)
                    echo "Read ${CMUX_HOME}/${role_template} for your role. You lead team '${prefix}'. Team members: ${all_members}. Your task: ${task}"
                    ;;
                *)
                    echo "Read ${CMUX_HOME}/${role_template} for your role. You are on team '${prefix}'. Report to ${lead}. Team members: ${all_members}. Your task (${role_label}): ${task}"
                    ;;
            esac
            ;;
        PLATFORM_TEAM)
            local lead="${prefix}-platform-lead"
            case "$suffix" in
                platform-lead)
                    echo "Read ${CMUX_HOME}/${role_template} for your role. You lead team '${prefix}'. Team members: ${all_members}. Your task: ${task}"
                    ;;
                *)
                    echo "Read ${CMUX_HOME}/${role_template} for your role. You are on team '${prefix}'. Report to ${lead}. Team members: ${all_members}. Your task (${role_label}): ${task}"
                    ;;
            esac
            ;;
        TIGER_TEAM)
            # Flat team — no lead. All members know each other. Reference the team template.
            local others
            others=$(echo "$all_members" | tr ',' '\n' | grep -v "^${worker_name}$" | tr '\n' ',' | sed 's/,$//')
            echo "URGENT: ${task}. You are Tiger Team member '${worker_name}'. Read ${CMUX_HOME}/docs/templates/teams/TIGER_TEAM.md. NO LEAD — coordinate directly with: ${others}. Fix fast."
            ;;
        DEBATE_PAIR)
            local other_name
            case "$suffix" in
                defender)
                    other_name="${prefix}-critic"
                    echo "Read ${CMUX_HOME}/${role_template} for your role. You are the Defender in debate team '${prefix}'. Your opponent: ${other_name}. Write proposals to .cmux/journal/$(date +%Y-%m-%d)/artifacts/${prefix}-debate/. Your task: ${task}"
                    ;;
                critic)
                    other_name="${prefix}-defender"
                    echo "Read ${CMUX_HOME}/${role_template} for your role. You are the Critic in debate team '${prefix}'. Your opponent: ${other_name}. Read proposals from .cmux/journal/$(date +%Y-%m-%d)/artifacts/${prefix}-debate/. Your task: Critique the Defender's proposal for: ${task}"
                    ;;
            esac
            ;;
    esac
}

#───────────────────────────────────────────────────────────────────────────────
# Commands
#───────────────────────────────────────────────────────────────────────────────

cmd_setup() {
    local template=""
    local task=""
    local prefix=""
    local project_id=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --name)
                [[ -z "${2:-}" ]] && die "--name requires a prefix argument"
                prefix="$2"
                shift 2
                ;;
            --project)
                [[ -z "${2:-}" ]] && die "--project requires an ID argument"
                project_id="$2"
                shift 2
                ;;
            *)
                if [[ -z "$template" ]]; then
                    template="$1"
                elif [[ -z "$task" ]]; then
                    task="$1"
                else
                    die "unexpected argument: $1"
                fi
                shift
                ;;
        esac
    done

    [[ -z "$template" ]] && die "usage: teams setup <TEMPLATE> '<task>' [--name <prefix>] [--project <id>]"
    [[ -z "$task" ]] && die "usage: teams setup <TEMPLATE> '<task>' [--name <prefix>] [--project <id>]"

    # Normalize template name to uppercase
    template=$(echo "$template" | tr '[:lower:]' '[:upper:]')

    # Validate template
    local roles
    roles=$(get_template_roles "$template") || die "unknown template: $template (try 'teams templates')"

    # Auto-generate prefix if not provided
    if [[ -z "$prefix" ]]; then
        prefix=$(auto_prefix "$task")
        [[ -z "$prefix" ]] && prefix="team-$(date +%s | tail -c 5)"
    fi

    # Sanitize prefix
    prefix=$(echo "$prefix" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-')

    ensure_teams_file

    # Check for existing team with this prefix
    if team_exists "$prefix"; then
        die "team with prefix '$prefix' already exists (use 'teams teardown $prefix' first)"
    fi

    echo ""
    info "Setting up ${BOLD}${template}${NC} team '${prefix}'"
    echo ""

    # Build member list
    local members=()
    while IFS=' ' read -r suffix role_path role_label; do
        members+=("${prefix}-${suffix}")
    done <<< "$roles"

    local all_members
    all_members=$(IFS=','; echo "${members[*]}")

    # Build project flags for workers spawn
    local project_flags=""
    if [[ -n "$project_id" ]]; then
        project_flags="--project $project_id"
    fi

    # Create debate artifacts directory if needed
    if [[ "$template" == "DEBATE_PAIR" ]]; then
        mkdir -p "${CMUX_HOME}/.cmux/journal/$(date +%Y-%m-%d)/artifacts/${prefix}-debate"
    fi

    # Spawn each worker
    local spawned=()
    while IFS=' ' read -r suffix role_path role_label; do
        local worker_name="${prefix}-${suffix}"
        local worker_task
        worker_task=$(build_worker_task "$template" "$suffix" "$role_path" "$task" "$prefix" "$all_members")

        info "Spawning ${worker_name} (${role_label//_/ })..."

        if "$WORKERS_TOOL" spawn "$worker_name" "$worker_task" $project_flags; then
            ok "Spawned ${worker_name}"
            spawned+=("$worker_name")
        else
            warn "Failed to spawn ${worker_name}"
        fi

        echo ""
    done <<< "$roles"

    # Record team in teams.json
    local now
    now=$(date -u +%Y-%m-%dT%H:%M:%SZ)
    local members_json
    members_json=$(printf '%s\n' "${spawned[@]}" | jq -R . | jq -s .)

    local tmp
    tmp=$(mktemp)
    jq --arg prefix "$prefix" \
       --arg template "$template" \
       --arg task "$task" \
       --arg now "$now" \
       --arg project "$project_id" \
       --argjson members "$members_json" \
       '.teams += [{
           prefix: $prefix,
           template: $template,
           task: $task,
           members: $members,
           project_id: $project,
           created_at: $now
       }]' "$TEAMS_FILE" > "$tmp" && mv "$tmp" "$TEAMS_FILE"

    # Summary
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    ok "Team '${prefix}' ready (${#spawned[@]} workers)"
    echo ""
    echo "  Template: $template"
    echo "  Task:     $task"
    [[ -n "$project_id" ]] && echo "  Project:  $project_id"
    echo ""
    echo "  Workers:"
    while IFS=' ' read -r suffix role_path role_label; do
        local wname="${prefix}-${suffix}"
        if printf '%s\n' "${spawned[@]}" | grep -qx "$wname"; then
            echo -e "    ${GREEN}●${NC} ${wname}  (${role_label//_/ })"
        else
            echo -e "    ${RED}●${NC} ${wname}  (${role_label//_/ }) — FAILED"
        fi
    done <<< "$roles"
    echo ""

    local lead
    lead=$(get_lead_suffix "$template")
    if [[ -n "$lead" ]]; then
        echo "  Lead: ${prefix}-${lead}"
        echo "  Send tasks via: ./tools/workers send \"${prefix}-${lead}\" \"[TASK] ...\""
    elif [[ "$template" == "TIGER_TEAM" ]]; then
        echo "  Flat team — no lead. Workers coordinate directly."
    elif [[ "$template" == "DEBATE_PAIR" ]]; then
        echo "  Defender starts. Artifacts: .cmux/journal/$(date +%Y-%m-%d)/artifacts/${prefix}-debate/"
    fi
    echo ""
}

cmd_teardown() {
    local prefix="${1:-}"
    [[ -z "$prefix" ]] && die "usage: teams teardown <prefix>"

    ensure_teams_file

    if ! team_exists "$prefix"; then
        warn "No team '$prefix' in registry — will still try to kill matching workers"
    fi

    info "Tearing down team: $prefix"

    # Get all tmux windows and kill those matching the prefix
    local windows
    windows=$(tmux list-windows -t "$CMUX_SESSION" -F '#{window_name}' 2>/dev/null || true)

    local killed=0
    while IFS= read -r window; do
        if [[ "$window" == ${prefix}-* ]]; then
            info "Killing $window..."
            "$WORKERS_TOOL" kill "$window" 2>/dev/null && ((killed++)) || warn "Failed to kill $window"
        fi
    done <<< "$windows"

    # Remove from teams.json
    if team_exists "$prefix"; then
        local tmp
        tmp=$(mktemp)
        jq --arg p "$prefix" '.teams |= map(select(.prefix != $p))' "$TEAMS_FILE" > "$tmp" && mv "$tmp" "$TEAMS_FILE"
    fi

    ok "Team '$prefix' torn down ($killed workers killed)"
}

cmd_status() {
    local prefix="${1:-}"
    local lines="${2:-15}"

    [[ -z "$prefix" ]] && die "usage: teams status <prefix> [lines]"

    ensure_teams_file

    # Get team info from registry if available
    local template=""
    if team_exists "$prefix"; then
        template=$(jq -r --arg p "$prefix" '.teams[] | select(.prefix == $p) | .template' "$TEAMS_FILE")
        local task
        task=$(jq -r --arg p "$prefix" '.teams[] | select(.prefix == $p) | .task' "$TEAMS_FILE")
        echo -e "${BOLD}Team: ${prefix}${NC} (${template})"
        echo -e "${DIM}Task: ${task}${NC}"
        echo ""
    fi

    # Find all windows matching prefix
    local windows
    windows=$(tmux list-windows -t "$CMUX_SESSION" -F '#{window_name}' 2>/dev/null || true)

    local found=0
    while IFS= read -r window; do
        if [[ "$window" == ${prefix}-* ]]; then
            ((found++))
            echo "━━━ ${window} ━━━"
            tmux capture-pane -t "${CMUX_SESSION}:${window}" -p -S "-${lines}" 2>/dev/null || echo "(could not capture)"
            echo ""
        fi
    done <<< "$windows"

    if [[ $found -eq 0 ]]; then
        warn "No workers found with prefix '$prefix'"
    else
        echo "Total: $found workers"
    fi
}

cmd_list() {
    ensure_teams_file

    local count
    count=$(jq '.teams | length' "$TEAMS_FILE")

    if [[ "$count" -eq 0 ]]; then
        echo -e "${DIM}No active teams${NC}"
        return
    fi

    echo -e "${BOLD}Active Teams${NC}"
    echo ""

    # Get active tmux windows for checking liveness
    local windows
    windows=$(tmux list-windows -t "$CMUX_SESSION" -F '#{window_name}' 2>/dev/null || true)

    jq -c '.teams[]' "$TEAMS_FILE" | while IFS= read -r team; do
        local prefix template task members created_at
        prefix=$(echo "$team" | jq -r '.prefix')
        template=$(echo "$team" | jq -r '.template')
        task=$(echo "$team" | jq -r '.task')
        created_at=$(echo "$team" | jq -r '.created_at')

        echo -e "  ${BOLD}${prefix}${NC} (${template})"
        echo -e "  ${DIM}Task: ${task}${NC}"
        echo -e "  ${DIM}Created: ${created_at}${NC}"

        # Show members with liveness
        echo "$team" | jq -r '.members[]' | while IFS= read -r member; do
            if echo "$windows" | grep -qx "$member"; then
                echo -e "    ${GREEN}●${NC} ${member}"
            else
                echo -e "    ${RED}●${NC} ${member} (dead)"
            fi
        done

        echo ""
    done

    echo "Total: $count team(s)"
}

cmd_templates() {
    echo -e "${BOLD}Available Team Templates${NC}"
    echo ""
    echo -e "  ${CYAN}SOLO_WORKER${NC}     1 worker       Simple, focused tasks and bug fixes"
    echo -e "  ${CYAN}SQUAD_MODEL${NC}     4 workers      Cross-functional: lead + backend + frontend + tester"
    echo -e "  ${CYAN}FEATURE_TEAM${NC}    3 workers      Hierarchical: tech lead + backend + frontend"
    echo -e "  ${CYAN}PLATFORM_TEAM${NC}   3 workers      Infrastructure: platform lead + infra + devops"
    echo -e "  ${CYAN}TIGER_TEAM${NC}      3 workers      Flat peers for urgent fixes (no lead)"
    echo -e "  ${CYAN}DEBATE_PAIR${NC}     2 workers      Structured argument: defender + critic"
    echo ""
    echo -e "${DIM}Usage: teams setup <TEMPLATE> '<task description>' [--name <prefix>]${NC}"
    echo ""
    echo "See docs/templates/teams/ for detailed template documentation."
}

cmd_help() {
    cat << 'EOF'
teams - Set up and manage team structures from templates

USAGE:
    teams <command> [arguments]

COMMANDS:
    setup <TEMPLATE> '<task>' [options]   Spawn a team from a template
    teardown <prefix>                     Kill all workers in a team
    status <prefix> [lines]               Show team members' terminal output
    list                                  List active teams
    templates                             List available team templates
    help                                  Show this help message

SETUP OPTIONS:
    --name <prefix>    Team prefix for worker names (default: auto-generated from task)
    --project <id>     Associate all workers with a project (passed to workers spawn)

TEMPLATES:
    SOLO_WORKER      1 worker — simple tasks
    SQUAD_MODEL      4 workers — lead + backend + frontend + tester
    FEATURE_TEAM     3 workers — tech lead + backend + frontend
    PLATFORM_TEAM    3 workers — platform lead + infra + devops
    TIGER_TEAM       3 workers — flat peers, no lead
    DEBATE_PAIR      2 workers — defender + critic

EXAMPLES:
    teams setup SQUAD_MODEL "Implement user auth with JWT" --name auth
    teams setup TIGER_TEAM "Fix production 500 errors" --name hotfix
    teams setup DEBATE_PAIR "Design caching strategy" --name cache
    teams status auth
    teams teardown auth
    teams list
    teams templates

ENVIRONMENT:
    CMUX_HOME        CMUX installation root (default: git root or pwd)
    CMUX_SESSION     tmux session name (default: cmux)
EOF
}

#───────────────────────────────────────────────────────────────────────────────
# Main
#───────────────────────────────────────────────────────────────────────────────

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        setup)      cmd_setup "$@" ;;
        teardown)   cmd_teardown "$@" ;;
        status)     cmd_status "$@" ;;
        list)       cmd_list "$@" ;;
        templates)  cmd_templates "$@" ;;
        help|--help|-h) cmd_help ;;
        *)          die "unknown command: $cmd (try 'teams help')" ;;
    esac
}

main "$@"
