#!/usr/bin/env bash
#===============================================================================
# prefs - TARS-style configurable preferences for CMUX agents
#
# Usage:
#   prefs list                    - Show all settings with values and descriptions
#   prefs get <key>               - Show one setting's value and description
#   prefs set <key> <value>       - Update a setting (1-10 integer)
#   prefs reset                   - Restore all to defaults
#   prefs help                    - Show usage
#
# Storage: .cmux/preferences.json
# All values are integers 1-10.
#===============================================================================

set -euo pipefail

CMUX_HOME="${CMUX_HOME:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"
PREFS_FILE="${CMUX_HOME}/.cmux/preferences.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

die() { echo -e "${RED}error:${NC} $1" >&2; exit 1; }
ok() { echo -e "${GREEN}✓${NC} $1"; }

#-------------------------------------------------------------------------------
# Setting descriptions
#-------------------------------------------------------------------------------

description_for() {
    case "$1" in
        alertness)      echo "How often to alert the user with sound/voice notifications" ;;
        verbosity)      echo "How detailed agent responses should be (1=terse, 10=explain everything)" ;;
        autonomy)       echo "How much agents do without asking (1=ask everything, 10=just do it)" ;;
        humor)          echo "How playful vs dry the tone is" ;;
        proactiveness)  echo "How aggressively to find work when idle" ;;
        journal_detail) echo "How much to journal (1=major events only, 10=everything)" ;;
        *)              echo "Unknown setting" ;;
    esac
}

VALID_KEYS="alertness verbosity autonomy humor proactiveness journal_detail"

DEFAULTS='{"alertness":7,"verbosity":5,"autonomy":7,"humor":3,"proactiveness":6,"journal_detail":5}'

#-------------------------------------------------------------------------------
# Helpers
#-------------------------------------------------------------------------------

ensure_prefs() {
    mkdir -p "$(dirname "$PREFS_FILE")"
    if [[ ! -f "$PREFS_FILE" ]]; then
        local now
        now=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        jq -n --arg now "$now" \
            '{alertness:7,verbosity:5,autonomy:7,humor:3,proactiveness:6,journal_detail:5,_meta:{updated_at:$now,updated_by:"system"}}' \
            > "$PREFS_FILE"
    fi
}

is_valid_key() {
    local key="$1"
    for k in $VALID_KEYS; do
        [[ "$k" == "$key" ]] && return 0
    done
    return 1
}

level_bar() {
    local val="$1"
    local bar=""
    for i in $(seq 1 10); do
        if [[ $i -le $val ]]; then
            bar="${bar}█"
        else
            bar="${bar}░"
        fi
    done
    echo "$bar"
}

level_color() {
    local val="$1"
    if [[ $val -le 3 ]]; then
        echo -e "${CYAN}"
    elif [[ $val -le 6 ]]; then
        echo -e "${YELLOW}"
    else
        echo -e "${GREEN}"
    fi
}

#-------------------------------------------------------------------------------
# Commands
#-------------------------------------------------------------------------------

cmd_list() {
    ensure_prefs

    echo -e "${BOLD}CMUX Agent Preferences${NC}"
    echo -e "${DIM}All values 1-10. Use 'prefs set <key> <value>' to change.${NC}"
    echo ""
    printf "${DIM}%-16s  %-5s  %-12s  %s${NC}\n" "SETTING" "VALUE" "LEVEL" "DESCRIPTION"
    echo -e "${DIM}────────────────  ─────  ────────────  ──────────────────────────────────────────────────${NC}"

    for key in $VALID_KEYS; do
        local val
        val=$(jq -r --arg k "$key" '.[$k]' "$PREFS_FILE")
        local color
        color=$(level_color "$val")
        local bar
        bar=$(level_bar "$val")
        local desc
        desc=$(description_for "$key")

        printf "%-16s  ${color}%-5s${NC}  ${color}%s${NC}  %s\n" "$key" "$val" "$bar" "$desc"
    done

    echo ""
    local updated_at updated_by
    updated_at=$(jq -r '._meta.updated_at // "unknown"' "$PREFS_FILE")
    updated_by=$(jq -r '._meta.updated_by // "unknown"' "$PREFS_FILE")
    echo -e "${DIM}Last updated: ${updated_at} by ${updated_by}${NC}"
}

cmd_get() {
    local key="${1:-}"
    [[ -z "$key" ]] && die "usage: prefs get <key>"

    is_valid_key "$key" || die "unknown setting: $key (valid: $VALID_KEYS)"

    ensure_prefs

    local val
    val=$(jq -r --arg k "$key" '.[$k]' "$PREFS_FILE")
    local desc
    desc=$(description_for "$key")
    local color
    color=$(level_color "$val")
    local bar
    bar=$(level_bar "$val")

    echo -e "${BOLD}${key}${NC}: ${color}${val}${NC}  ${color}${bar}${NC}"
    echo -e "${DIM}${desc}${NC}"
}

cmd_set() {
    local key="${1:-}"
    local value="${2:-}"

    [[ -z "$key" ]] && die "usage: prefs set <key> <value>"
    [[ -z "$value" ]] && die "usage: prefs set <key> <value>"

    is_valid_key "$key" || die "unknown setting: $key (valid: $VALID_KEYS)"

    # Validate integer 1-10
    if ! [[ "$value" =~ ^[0-9]+$ ]] || [[ "$value" -lt 1 ]] || [[ "$value" -gt 10 ]]; then
        die "value must be an integer from 1 to 10 (got: $value)"
    fi

    ensure_prefs

    local now
    now=$(date -u +%Y-%m-%dT%H:%M:%SZ)
    local agent_name="${CMUX_AGENT_NAME:-user}"

    jq --arg k "$key" --argjson v "$value" --arg now "$now" --arg by "$agent_name" \
        '.[$k] = $v | ._meta.updated_at = $now | ._meta.updated_by = $by' \
        "$PREFS_FILE" > "${PREFS_FILE}.tmp" \
        && mv "${PREFS_FILE}.tmp" "$PREFS_FILE"

    local color
    color=$(level_color "$value")
    local bar
    bar=$(level_bar "$value")
    ok "${key} → ${color}${value}${NC}  ${color}${bar}${NC}"
}

cmd_reset() {
    ensure_prefs

    local now
    now=$(date -u +%Y-%m-%dT%H:%M:%SZ)
    local agent_name="${CMUX_AGENT_NAME:-user}"

    jq -n --arg now "$now" --arg by "$agent_name" \
        '{alertness:7,verbosity:5,autonomy:7,humor:3,proactiveness:6,journal_detail:5,_meta:{updated_at:$now,updated_by:$by}}' \
        > "$PREFS_FILE"

    ok "All preferences reset to defaults"
    echo ""
    cmd_list
}

cmd_help() {
    cat << 'EOF'
prefs - TARS-style configurable preferences for CMUX agents

USAGE:
    prefs <command> [arguments]

COMMANDS:
    list                Show all settings with values and descriptions
    get <key>           Show one setting's value and description
    set <key> <value>   Update a setting (1-10 integer)
    reset               Restore all to defaults
    help                Show this help

SETTINGS:
    alertness       How often to alert the user with sound/voice notifications
    verbosity       How detailed agent responses should be (1=terse, 10=explain everything)
    autonomy        How much agents do without asking (1=ask everything, 10=just do it)
    humor           How playful vs dry the tone is
    proactiveness   How aggressively to find work when idle
    journal_detail  How much to journal (1=major events only, 10=everything)

EXAMPLES:
    prefs list                     # See all settings
    prefs set humor 8              # Turn up the humor
    prefs set alertness 3          # Fewer notifications
    prefs set autonomy 10          # Maximum autonomy
    prefs get verbosity            # Check current verbosity
    prefs reset                    # Restore defaults

ENVIRONMENT:
    CMUX_HOME          Project root (default: git rev-parse --show-toplevel)
    CMUX_AGENT_NAME    Agent name for audit trail (default: user)

STORAGE:
    .cmux/preferences.json — all values are integers 1-10, with _meta timestamps.
EOF
}

#-------------------------------------------------------------------------------
# Main
#-------------------------------------------------------------------------------

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        list|ls)    cmd_list "$@" ;;
        get)        cmd_get "$@" ;;
        set)        cmd_set "$@" ;;
        reset)      cmd_reset "$@" ;;
        help|--help|-h) cmd_help ;;
        *)          die "unknown command: $cmd (try 'prefs help')" ;;
    esac
}

main "$@"
