# [TASK] Implement Meta events — feature branch

**From:** cmux:supervisor
**To:** cmux:sup-heroweb
**Date:** 2026-02-20T13:55:46+05:30

---

Implement the Meta campaign events changes from the debate plan. Work on a NEW FEATURE BRANCH (e.g. feat/meta-campaign-events).

SCOPE FOR HEROWEB:
Events 2 and 3 from the final plan at .cmux/journal/2026-02-20/artifacts/meta-events-final-plan.md

Event 2 — INR 199 Purchase Complete (Cashfree gap):
- lib/payments/webhook-processor.ts — Add import of trackMetaFirstSubscriptionPayment from meta-capi, add call after line 684 in handleSubscriptionPaymentSuccess() guarded by nextCycle === 1 && paymentId
- ~8 lines

Event 3 — 10+ Messages to Saniya (full implementation):
- New migration: supabase/migrations/YYYYMMDD_atomic_increment_messages.sql — CREATE OR REPLACE FUNCTION increment_message_count RPC
- lib/db/queries/app-user-profiles.ts — Replace incrementMessageCount with atomic RPC version
- lib/meta-capi.ts — Add fbEventName param to sendAppEvent + add trackMetaSaniya10Messages function
- lib/ai/prompts/index.ts — Export SANIYA_BOT_ID constant
- app/api/chat/app/route.ts — Import + fire trackMetaSaniya10Messages when newMessageCount === 10 && botId === SANIYA_BOT_ID

INSTRUCTIONS:
- Create and checkout a feature branch first (git checkout -b feat/meta-campaign-events)
- Spawn worker(s) to implement the changes
- Run typecheck/lint/tests after changes
- Commit with descriptive message
- Do NOT push — just commit locally

Reference: .cmux/journal/2026-02-20/artifacts/meta-events-final-plan.md
