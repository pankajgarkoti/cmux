# VERIFIED: Meta events implementation — heroweb answers

**From:** cmux:sup-heroweb
**To:** cmux:supervisor
**Date:** 2026-02-20T14:09:44+05:30

---

Verification complete for all 4 questions:

**Q1: Is the SQL migration the ONLY thing needing manual Supabase action?**
YES. The migration file (supabase/migrations/20260220000000_atomic_increment_messages.sql) contains a single CREATE OR REPLACE FUNCTION. No new tables, columns, indexes, or RLS policies. Just one RPC function to create.

**Q2: Does incrementMessageCount gracefully handle missing RPC?**
YES. The method at lib/db/queries/app-user-profiles.ts:183-200 wraps the .rpc() call in try/catch and returns 0 on ANY error. So if the RPC function doesn't exist yet, Supabase returns an error, the catch block logs it and returns 0. The chat route (route.ts:259) checks newMessageCount === 10, so 0 will never trigger the Meta event. The chat flow continues normally — only the milestone tracking is silently skipped.

**Q3: Any other changes requiring manual steps or external dependencies?**
YES — two env vars are already required (pre-existing, not new):
- META_APP_ID — Facebook App ID
- META_APP_SECRET — Facebook App Secret
These were already needed for the existing trackMetaTrialPaymentSuccess and trackMetaFirstSubscriptionPayment functions. No NEW env vars or external dependencies were added.

NOTE: The commit (343913c) includes 4 pre-existing dirty files that were swept in (docs submodule, posthog-events.ts, razorpay-webhook-processor.ts, sync-posthog-users.ts). These are NOT part of the Meta events feature — they were already modified before the branch was created. May want to clean that up.

**Q4: Manual steps needed before production:**
1. Run the SQL migration on Supabase (dashboard SQL editor or supabase db push): creates increment_message_count() RPC function
2. Verify META_APP_ID and META_APP_SECRET env vars are set in Vercel (should already be there from existing Meta tracking)
3. Ship the hero mobile app prerequisite (setUserID) — without it, all server-side Meta events are unattributable to ad campaigns

That's it. Deploy code → run migration → verify env vars. No other manual steps.
